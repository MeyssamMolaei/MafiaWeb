<!DOCTYPE html>
<html lang="fa" dir="rtl">

  <head>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>کافه مافیا</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/script.js"></script>
  </head>

  <body>
    <img class="logo-img" src="img/logo.jpg">
    <div id="setup">
      <!-- <h2>نام بازکنان و نقش‌ها را وارد کنید</h2> -->
      <div>
        <div class="div-label">
          <label>بازیکنان:</label>
        </div>
        <textarea id="players"></textarea>
      </div>
      <div>
        <div class="div-label">
          <label>نقش‌ها:</label>
        </div>
        <textarea id="roles"></textarea>
      </div>
      <button class="blue" onclick="startGame()">آماده؟</button>
    </div>

    <div id="playing" style="display:none;">
      <h2 id="playerName"></h2>
      <h3 id="playerRole" style="display:none;"></h3>
      <button class="green" onclick="assignRole()" id="roleBtn">نقش منو نشون بده</button>
    </div>

    <div id="confirmation" style="display:none;">
      <h3>همه بازیکن‌ها نقش‌هاشون رو گرفتن؟</h3>
      <button class="red" onclick="confirmGameEnd()">بله، لیست بازیکن‌ها رو نشون بده</button>
    </div>

    <div id="results" style="display:none;">
      <h2>لیست بازیکنان و نقش‌ها</h2>
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>نقش</th>
            <th>بازیکن</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>

  </body>
  <script>

    let playerList = [];
    let roleList = [];
    let assignments = [];
    let currentIndex = 0;
    let showRole = false;
    // console.log("Helli!!!!!!!!");
    window.onload = () => {
      const savedPlayers = localStorage.getItem('playersText');
      const savedRoles = localStorage.getItem('rolesText');
      if (savedPlayers) document.getElementById('players').value = savedPlayers;
      if (savedRoles) document.getElementById('roles').value = savedRoles;
    };

    function playBeep() {
      const audio = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=");
      audio.play();
    }

    function startGame() {
      const playersText = document.getElementById("players").value.trim();
      const rolesText = document.getElementById("roles").value.trim();

      // Save inputs to localStorage
      localStorage.setItem("playersText", playersText);
      localStorage.setItem("rolesText", rolesText);

      playerList = playersText.split("\n").map(p => p.trim()).filter(p => p);
      roleList = rolesText.split("\n").map(r => r.trim()).filter(r => r);

      if (playerList.length !== roleList.length) {
        alert("تعداد بازیکن‌ها و نقش‌ها باید برابر باشد");
        return;
      }

      roleList = shuffle(roleList);
      assignments = [];
      currentIndex = 0;
      showRole = false;

      document.getElementById("setup").style.display = "none";
      document.getElementById("playing").style.display = "block";
      updatePlayerView();
    }

    function updatePlayerView() {
      document.getElementById("playerName").textContent = playerList[currentIndex];
      document.getElementById("playerRole").style.display = "none";
      document.getElementById("roleBtn").textContent = "نقش منو نشون بده";
    }

    function assignRole() {
      playBeep();
      if (!showRole) {
        assignments.push({ player: playerList[currentIndex], role: roleList[currentIndex] });
        document.getElementById("playerRole").textContent = "در نقش " + roleList[currentIndex];
        document.getElementById("playerRole").style.display = "block";
        document.getElementById("roleBtn").textContent = "بعدی";
        showRole = true;
      } else {
        currentIndex++;
        if (currentIndex < playerList.length) {
          showRole = false;
          updatePlayerView();
        } else {
          document.getElementById("playing").style.display = "none";
          document.getElementById("confirmation").style.display = "block";
        }
      }
    }

    function confirmGameEnd() {
      const resultsBody = document.getElementById("resultsBody");
      resultsBody.innerHTML = "";
      assignments.sort((a, b) => roleList.indexOf(a.role) - roleList.indexOf(b.role)).forEach((item, index) => {
        resultsBody.innerHTML += `<tr><td>${index + 1}</td><td>${item.role}</td><td>${item.player}</td></tr>`;
      });
      document.getElementById("confirmation").style.display = "none";
      document.getElementById("results").style.display = "block";
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.error('Service Worker registration failed:', err));
      });
    }

  </script>

</html>